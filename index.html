<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ‹æ‰‹ãƒšãƒ¼ã‚¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">

<style>
body {
  font-family: sans-serif;
  background-color: #9370db;
  margin: 0;
  padding: 20px;
  text-align: center;
  color: #fff;
}
#image-box img {
  max-width: 90%;
  margin: 20px auto;
  display: block;
}
textarea {
  width: 50%;
  height: 80px;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
  font-size: 16px;
  resize: vertical;
}
button {
  padding: 12px 22px;
  margin-top: 10px;
  border: none;
  border-radius: 6px;
  background-color: #282828;
  font-size: 16px;
  cursor: pointer;
  color: #fff;
}
#page-num {
  margin-top: 10px;
  font-size: 18px;
  color: #000;
}
.footer-copy {
  color: #000;
  margin-top: 30px;
  font-size: 14px;
}
</style>
</head>

<body>

<h2 style="color:#000;">ğŸ’€æ‹æ‰‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ‘¹</h2>

<div id="image-box">
  <img id="main-image" src="1_v2.gif" alt="ãŠç¤¼ç”»åƒ">
</div>

<div id="page-num">(1/4)</div>

<textarea id="message" placeholder="ãªã«ã‹ã”ã–ã„ã¾ã—ãŸã‚‰"></textarea><br>
<button id="sendClapBtn">é€ä¿¡</button>

<p class="footer-copy">Â© 2021 yawaraka_doku_onyx All Rights Reserved.</p>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { 
  getFirestore, doc, getDoc, setDoc, updateDoc, 
  collection, addDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC74BiEEMF1D8C7Ll99kWBJE5UqTC8T8Hw",
  authDomain: "kado-onyx-clap.firebaseapp.com",
  projectId: "kado-onyx-clap",
  storageBucket: "kado-onyx-clap.firebasestorage.app",
  messagingSenderId: "1038961543704",
  appId: "1:1038961543704:web:114b43697f055c2f8f116d",
  measurementId: "G-DH6JB7CKPV"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

// -----------------------------
// ãƒšãƒ¼ã‚¸è¨ªå•ã‚«ã‚¦ãƒ³ãƒˆ
// -----------------------------
async function addVisit() {
  const today = new Date().toISOString().slice(0,10); // YYYY-MM-DD
  const ref = doc(db, "visits", today);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    await updateDoc(ref, { count: (snap.data().count || 0) + 1 });
  } else {
    await setDoc(ref, { count: 1 });
  }
}
addVisit();

// -----------------------------
// ãŠç¤¼ç”»åƒ
// -----------------------------
const images = ["1_v2.gif","2.png","3.png","4.png"];
let idx = 0;

function updateImage() {
  document.getElementById("main-image").src = images[idx];
  document.getElementById("page-num").textContent = `(${idx+1}/${images.length})`;
}

function nextImage() {
  idx = (idx + 1) % images.length;
  updateImage();
}

// -----------------------------
// æ‹æ‰‹
// -----------------------------
const clapRef = doc(db, "claps", "main");

async function addClap() {
  const snap = await getDoc(clapRef);
  if (snap.exists()) {
    await updateDoc(clapRef, { count: (snap.data().count || 0) + 1 });
  } else {
    await setDoc(clapRef, { count: 1 });
  }
}

// -----------------------------
// é€£æ‰“é˜²æ­¢ï¼ˆ15å›ã¾ã§å³æ™‚ï¼‰
// -----------------------------
let rapid = 0;
const maxRapid = 15;

function canClap() {
  if (rapid < maxRapid) {
    rapid++;
    setTimeout(() => rapid = Math.max(0, rapid - 1), 60000);
    return true;
  }
  return false;
}

// -----------------------------
document.getElementById("sendClapBtn").addEventListener("click", async () => {
  if (!canClap()) {
    alert("ãŠã¡ã¤ã„ã¦ãã ã•ã„");
    return;
  }

  const text = document.getElementById("message").value.trim();
  if (text) {
    await addDoc(collection(db,"messages"), {
      text: text,
      timestamp: serverTimestamp()
    });
  }

  await addClap();
  nextImage();
  document.getElementById("message").value = "";
});

document.getElementById("main-image").addEventListener("click", nextImage);

updateImage();
</script>
</body>
</html>
