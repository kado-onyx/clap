<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>æ‹æ‰‹ãƒšãƒ¼ã‚¸</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link rel="icon" type="image/png" href="favicon.png">
<link rel="apple-touch-icon" href="favicon.png">

<style>
body {
  font-family: sans-serif;
  background-color: #9370db;
  margin: 0;
  padding: 20px;
  text-align: center;
  color: #fff;
}
h2 { margin-top: 0; color:#000; }

#image-box img {
  max-width: 90%;
  margin: 20px auto;
  display: block;
}

textarea {
  width: 50%;
  height: 80px;
  padding: 10px;
  margin-top: 10px;
  border-radius: 6px;
  border: none;
  font-size: 16px;
  resize: vertical;
}

button {
  padding: 12px 22px;
  margin-top: 10px;
  border: none;
  border-radius: 6px;
  background-color: #282828;
  font-size: 16px;
  cursor: pointer;
  color: #fff;
}

#page-num {
  margin-top: 10px;
  font-size: 18px;
  color: #000;
}

.footer-copy {
  color: #000;
  margin-top: 30px;
  font-size: 14px;
}
</style>
</head>

<body>

<h2>ğŸ’€æ‹æ‰‹ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ğŸ‘¹</h2>

<div id="image-box">
  <img id="main-image" src="1_v2.gif" alt="ãŠç¤¼ç”»åƒ">
</div>

<div id="page-num">(1/4)</div>

<textarea id="message" placeholder="ãªã«ã‹ã”ã–ã„ã¾ã—ãŸã‚‰"></textarea><br>
<button id="sendClapBtn">é€ä¿¡</button>

<p class="footer-copy">Â© 2021 yawaraka_doku_onyx All Rights Reserved.</p>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc,
    collection, addDoc, serverTimestamp, increment
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  // --- Firebaseè¨­å®š ---
  const firebaseConfig = {
    apiKey: "AIzaSyC74BiEEMF1D8C7Ll99kWBJE5UqTC8T8Hw",
    authDomain: "kado-onyx-clap.firebaseapp.com",
    projectId: "kado-onyx-clap",
    storageBucket: "kado-onyx-clap.firebasestorage.app",
    messagingSenderId: "1038961543704",
    appId: "1:1038961543704:web:114b43697f055c2f8f116d",
    measurementId: "G-DH6JB7CKPV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ============================================================
  // (A) æ—¥ä»˜ã‚­ãƒ¼ãƒ»æ™‚é–“ã‚­ãƒ¼ä½œæˆï¼ˆCæ¡ˆï¼‰
  // ============================================================
  function getTodayKey() {
    const d = new Date();
    return `${d.getFullYear()}-${("0"+(d.getMonth()+1)).slice(-2)}-${("0"+d.getDate()).slice(-2)}`;
  }
  function getCurrentHour() {
    return new Date().getHours().toString();
  }

  // ============================================================
  // (B) æ‹æ‰‹ã®æ™‚é–“åˆ¥é›†è¨ˆä¿å­˜
  // ============================================================
  async function addClapHourly() {
    const today = getTodayKey();
    const hour = getCurrentHour();

    const ref = doc(db, "clap_stats", today);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      const base = {};
      for (let i = 0; i < 24; i++) base[i] = 0;

      await setDoc(ref, {
        ...base,
        total: 1,
        [hour]: 1
      });
    } else {
      await updateDoc(ref, {
        total: increment(1),
        [hour]: increment(1)
      });
    }
  }

  // ============================================================
  // (C) è¨ªå•ã®æ™‚é–“åˆ¥é›†è¨ˆä¿å­˜ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼‰
  // ============================================================
  async function addVisitHourly() {
    const today = getTodayKey();
    const hour = getCurrentHour();

    const ref = doc(db, "visit_stats", today);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      const base = {};
      for (let i = 0; i < 24; i++) base[i] = 0;
      await setDoc(ref, {
        ...base,
        total: 1,
        [hour]: 1
      });
    } else {
      await updateDoc(ref, {
        total: increment(1),
        [hour]: increment(1)
      });
    }
  }

  // ãƒšãƒ¼ã‚¸è¨ªå•æ™‚ã‚«ã‚¦ãƒ³ãƒˆ
  addVisitHourly();

  // ============================================================
  // (D) ãŠç¤¼ç”»åƒï¼ˆãƒšãƒ¼ã‚¸é€ã‚Šï¼‰
  // ============================================================
  const images = ["1_v2.gif","2.png","3.png","4.png"];
  let idx = 0;

  function updateImage() {
    document.getElementById("main-image").src = images[idx];
    document.getElementById("page-num").textContent = `(${idx+1}/${images.length})`;
  }

  function nextImage() {
    idx = (idx + 1) % images.length;
    updateImage();
  }

  // ============================================================
  // (E) æ‹æ‰‹ã‚«ã‚¦ãƒ³ãƒˆï¼ˆç·æ•°ï¼‰
  // ============================================================
  const clapDocRef = doc(db, "claps", "main");

  async function addClapToFirebase() {
    const snap = await getDoc(clapDocRef);
    if (snap.exists()) {
      await updateDoc(clapDocRef, { count: (snap.data().count || 0) + 1 });
    } else {
      await setDoc(clapDocRef, { count: 1 });
    }
  }

  // ============================================================
  // (F) é€£æ‰“åˆ¶å¾¡ï¼ˆ15å›ã¾ã§å³æ™‚OKï¼‰
  // ============================================================
  let rapidClicks = 0;
  const maxRapid = 15;

  function canClapNow() {
    if (rapidClicks < maxRapid) {
      rapidClicks++;
      setTimeout(() => {
        rapidClicks = Math.max(0, rapidClicks - 1);
      }, 60000);
      return true;
    }
    return false;
  }

  // ============================================================
  // (G) ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆé€ä¿¡ãƒœã‚¿ãƒ³ï¼‰
  // ============================================================
  document.getElementById("sendClapBtn").addEventListener("click", async () => {

    if (!canClapNow()) {
      alert("ãŠã¡ã¤ã„ã¦ãã ã•ã„");
      return;
    }

    const text = document.getElementById("message").value.trim();

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¿å­˜
    if (text) {
      await addDoc(collection(db, "messages"), {
        text: text,
        timestamp: serverTimestamp()
      });
    }

    // æ‹æ‰‹ã®ç·æ•° +1
    await addClapToFirebase();

    // æ‹æ‰‹ã‚’æ™‚é–“åˆ¥ +1
    await addClapHourly();

    nextImage();
    document.getElementById("message").value = "";
  });

  // ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§ã‚‚ãƒšãƒ¼ã‚¸é€ã‚Š
  document.getElementById("main-image").addEventListener("click", nextImage);

  // åˆæœŸè¡¨ç¤º
  updateImage();
</script>
</body>
</html>
