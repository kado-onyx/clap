<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</title>

<style>
body {
  background: #222;
  color: #fff;
  font-family: sans-serif;
  padding: 20px;
}
input {
  padding: 8px;
  width: 200px;
  font-size: 16px;
}
button {
  padding: 8px 16px;
  margin-left: 10px;
  font-size: 14px;
}
#content {
  display: none;
  margin-top: 20px;
}
.message-box {
  background: #333;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
}
</style>
</head>

<body>

<h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ï¼‹æ‹æ‰‹æ•°ï¼‰</h2>

<p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
<input type="password" id="pwInput">
<button id="pwBtn">OK</button>

<div id="content">
  <h3>ğŸ“¬ ç›´è¿‘1ã‹æœˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§</h3>
  <div id="messages"></div>

  <h3>ğŸ‘ æ‹æ‰‹æ•°</h3>
  <p id="clapCount">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, query, where, Timestamp }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC74BiEEMF1D8C7Ll99kWBJE5UqTC8T8Hw",
    authDomain: "kado-onyx-clap.firebaseapp.com",
    projectId: "kado-onyx-clap",
    storageBucket: "kado-onyx-clap.firebasestorage.app",
    messagingSenderId: "1038961543704",
    appId: "1:1038961543704:web:114b43697f055c2f8f116d",
    measurementId: "G-DH6JB7CKPV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
  function checkPW() {
    const input = document.getElementById("pwInput").value;
    const correct = "onyx123";

    if (input === correct) {
      document.getElementById("content").style.display = "block";
      loadData();
    } else {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
  }

  document.getElementById("pwBtn").onclick = checkPW;

  // â–¼ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æ‹æ‰‹ï¼‰
  async function loadData() {

    // â–¼ ç›´è¿‘1ã‹æœˆ
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

    const q = query(
      collection(db, "messages"),
      where("timestamp", ">=", Timestamp.fromDate(oneMonthAgo))
    );

    const querySnapshot = await getDocs(q);

    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "";

    querySnapshot.forEach(doc => {
      const d = doc.data();
      const date = d.timestamp.toDate().toLocaleString("ja-JP");
      
     msgBox.innerHTML += `
  <div class="message-box" id="msg-${doc.id}">
    <strong>ğŸ“… ${date}</strong><br>
    ${d.text}
    <br><br>
    <button onclick="savePNG('msg-${doc.id}', '${date}')">ğŸ–¼ PNGä¿å­˜</button>
  </div>
      `;
    });

    if (querySnapshot.empty) {
      msgBox.innerHTML = "<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    }

    // â–¼ æ‹æ‰‹æ•°
    const clapSnap = await getDoc(doc(db, "claps", "main"));
    if (clapSnap.exists()) {
      document.getElementById("clapCount").textContent =
        clapSnap.data().count + " å›";
    } else {
      document.getElementById("clapCount").textContent = "0 å›";
    }
  }

</script>
<script>
// â–¼ PNGä¿å­˜ï¼ˆè£…é£¾ãƒ•ãƒ¬ãƒ¼ãƒ ä»˜ã & ã‚µã‚¤ã‚ºå›ºå®šï¼‰
function savePNG(elementId, dateText) {
  const element = document.getElementById(elementId);

  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  //   1. html2canvas ã§è¦ç´ ã‚’ç”»åƒåŒ–
  // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  html2canvas(element, { scale: 2 }).then(canvas => {

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   2. å›ºå®šã‚µã‚¤ã‚ºã®ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆ
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const W = 300;  // â† æœ€çµ‚ç”»åƒã®æ¨ªå¹…
    const H = 400;  // â† æœ€çµ‚ç”»åƒã®ç¸¦å¹…

    const fixedCanvas = document.createElement("canvas");
    fixedCanvas.width = W;
    fixedCanvas.height = H;

    const ctx = fixedCanvas.getContext("2d");

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   3. èƒŒæ™¯ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ç”¨ï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.fillStyle = "#faf5ff";     // â† èƒŒæ™¯è‰²ï¼ˆè–„ã„ç´«ãªã©å¤‰æ›´å¯ï¼‰
    ctx.fillRect(0, 0, W, H);

    // æ ç·šï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
    ctx.strokeStyle = "#9370db";   // â† ãƒ•ãƒ¬ãƒ¼ãƒ ã®è‰²
    ctx.lineWidth = 6;
    ctx.strokeRect(5, 5, W - 10, H - 10);

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   4. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ç”»åƒã‚’ç¸®å°ã—ã¦è²¼ã‚Šä»˜ã‘
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const img = new Image();
    img.onload = () => {
      // ã‚­ãƒ£ãƒ³ãƒã‚¹ä¸­å¤®ã«é…ç½®
      const padding = 20;
      const contentW = W - padding * 2;
      const contentH = H - padding * 2;

      ctx.drawImage(img, padding, padding, contentW, contentH);

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      //   5. ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã€Œæ—¥ä»˜_message.pngã€ã«ã™ã‚‹
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      const safeDate = dateText.replace(/[\/: ]/g, "-");
      const filename = safeDate + "_message.png";

      // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const link = document.createElement("a");
      link.download = filename;
      link.href = fixedCanvas.toDataURL("image/png");
      link.click();
    };

    // html2canvas ã®çµæœã‚’ img ã«èª­ã¿è¾¼ã¿
    img.src = canvas.toDataURL("image/png");
  });
}
</script>

</body>
</html>
