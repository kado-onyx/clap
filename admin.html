<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</title>

<style>
body {
  background: #222;
  color: #fff;
  font-family: sans-serif;
  padding: 20px;
}
input {
  padding: 8px;
  width: 200px;
  font-size: 16px;
}
button {
  padding: 8px 16px;
  margin-left: 10px;
  font-size: 14px;
}
#content {
  display: none;
  margin-top: 20px;
}
.message-box {
  background: #333;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
}
</style>
  
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>  

</head>

<body>

<h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ï¼‹æ‹æ‰‹æ•°ï¼‰</h2>

<p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
<input type="password" id="pwInput">
<button id="pwBtn">OK</button>

<div id="content">
  <h3>ğŸ“¬ ç›´è¿‘1ã‹æœˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§</h3>
  <div id="messages"></div>

  <h3>ğŸ‘ æ‹æ‰‹æ•°</h3>
  <p id="clapCount">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, query, where, Timestamp }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC74BiEEMF1D8C7Ll99kWBJE5UqTC8T8Hw",
    authDomain: "kado-onyx-clap.firebaseapp.com",
    projectId: "kado-onyx-clap",
    storageBucket: "kado-onyx-clap.firebasestorage.app",
    messagingSenderId: "1038961543704",
    appId: "1:1038961543704:web:114b43697f055c2f8f116d",
    measurementId: "G-DH6JB7CKPV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
  function checkPW() {
    const input = document.getElementById("pwInput").value;
    const correct = "onyx123";

    if (input === correct) {
      document.getElementById("content").style.display = "block";
      loadData();
    } else {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
  }

  document.getElementById("pwBtn").onclick = checkPW;

  // â–¼ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æ‹æ‰‹ï¼‰
  async function loadData() {

    // â–¼ ç›´è¿‘1ã‹æœˆ
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

    const q = query(
      collection(db, "messages"),
      where("timestamp", ">=", Timestamp.fromDate(oneMonthAgo))
    );

    const querySnapshot = await getDocs(q);

    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "";

    querySnapshot.forEach(doc => {
      const d = doc.data();
      const date = d.timestamp.toDate().toLocaleString("ja-JP");
      
     msgBox.innerHTML += `
  <div class="message-box" id="msg-${doc.id}">
    <strong>ğŸ“… ${date}</strong><br>
    ${d.text}
    <br><br>
    <button onclick="savePNG('msg-${doc.id}', '${date}')">ğŸ–¼ PNGä¿å­˜</button>
  </div>
      `;
    });

    if (querySnapshot.empty) {
      msgBox.innerHTML = "<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    }

    // â–¼ æ‹æ‰‹æ•°
    const clapSnap = await getDoc(doc(db, "claps", "main"));
    if (clapSnap.exists()) {
      document.getElementById("clapCount").textContent =
        clapSnap.data().count + " å›";
    } else {
      document.getElementById("clapCount").textContent = "0 å›";
    }
  }

</script>
<script>
// =============================
// PNG ç”Ÿæˆç”¨ï¼ˆframe.png ä½¿ç”¨ï¼‰
// =============================
async function saveMessageAsPng(dateStr, messageText) {
    const frameImg = new Image();
    frameImg.src = "frame.png"; // 320Ã—128 ã®ç”»åƒ
    await frameImg.decode();

    const baseWidth = 320;
    const frameHeight = frameImg.height; // 128px

    // ã‚­ãƒ£ãƒ³ãƒã‚¹ä½œæˆï¼ˆã¾ãšã¯æœ€ä½ã‚µã‚¤ã‚ºï¼‰
    let canvas = document.createElement("canvas");
    canvas.width = baseWidth;
    canvas.height = frameHeight;
    let ctx = canvas.getContext("2d");

    // ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚¹ã‚’OFFï¼ˆãƒ‰ãƒƒãƒˆæ„Ÿã‚’æ®‹ã™ï¼‰
    ctx.imageSmoothingEnabled = false;

    // --- åŸºæœ¬ã®ãƒ•ãƒ¬ãƒ¼ãƒ æç”» ---
    ctx.drawImage(frameImg, 0, 0);

    // --- ãƒ•ã‚©ãƒ³ãƒˆè¨­å®šï¼ˆãƒ‰ãƒƒãƒˆèª¿ãƒ»ã‚¢ãƒ³ãƒã‚¨ã‚¤ãƒªã‚¢ã‚¹ãªã—ï¼‰---
    ctx.font = "12px sans-serif";
    ctx.fillStyle = "#ffffff";
    ctx.textBaseline = "top";

    // ---- æ—¥ä»˜ ----
    const dateX = 21;
    const dateY = 32;
    ctx.fillText(dateStr, dateX, dateY);

    // ---- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ----
    const msgX = 21;
    let msgY = dateY + 18; // æ—¥ä»˜ã®ä¸‹ã‹ã‚‰æ›¸ãå§‹ã‚ã‚‹

    const maxWidth = 320 - 40; // å·¦å³21px ãã‚‰ã„ã®ä½™ç™½ç¢ºä¿

    // è¡Œåˆ†å‰²å‡¦ç†
    const lines = wrapText(ctx, messageText, maxWidth);

    // å¿…è¦ãªé«˜ã•ã‚’è¨ˆç®—ï¼ˆè¡Œæ•°ã«ã‚ˆã£ã¦å¯å¤‰ï¼‰
    const lineHeight = 16; // 12pxãƒ•ã‚©ãƒ³ãƒˆ Ã— è¡Œé–“
    const neededHeight = msgY + lines.length * lineHeight + 20;

    if (neededHeight > frameHeight) {
        // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä¼¸ã°ã™ï¼ˆä¸‹æ–¹å‘ï¼‰
        const newCanvas = document.createElement("canvas");
        newCanvas.width = baseWidth;
        newCanvas.height = neededHeight;
        const newCtx = newCanvas.getContext("2d");
        newCtx.imageSmoothingEnabled = false;

        // ä¸Šéƒ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
        newCtx.drawImage(canvas, 0, 0);

        // ä¸‹éƒ¨ã‚¹ãƒšãƒ¼ã‚¹ã‚’é»’èƒŒæ™¯ã§å¡—ã‚Šã¤ã¶ã—
        newCtx.fillStyle = "#000000";
        newCtx.fillRect(0, frameHeight, baseWidth, neededHeight - frameHeight);

        ctx = newCtx;
        canvas = newCanvas;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æç”»
    lines.forEach(line => {
        ctx.fillText(line, msgX, msgY);
        msgY += lineHeight;
    });

    // PNGä¿å­˜
    const link = document.createElement("a");
    link.download = `${dateStr.replace(/\//g,"-")}_message.png`;
    link.href = canvas.toDataURL("image/png");
    link.click();
}

// =============================
// è¡Œåˆ†å‰²ï¼ˆæŠ˜ã‚Šè¿”ã—ï¼‰
// =============================
function wrapText(ctx, text, maxWidth) {
    const words = text.split("");
    let line = "";
    let lines = [];

    for (let char of words) {
        const test = line + char;
        if (ctx.measureText(test).width > maxWidth) {
            lines.push(line);
            line = char;
        } else {
            line = test;
        }
    }
    if (line) lines.push(line);
    return lines;
}
</script>


</body>
</html>
