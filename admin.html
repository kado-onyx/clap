<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</title>

<style>
body {
  background: #222;
  color: #fff;
  font-family: sans-serif;
  padding: 20px;
}
input {
  padding: 8px;
  width: 200px;
  font-size: 16px;
}
button {
  padding: 8px 16px;
  margin-left: 10px;
  font-size: 14px;
}
#content {
  display: none;
  margin-top: 20px;
}
.message-box {
  background: #333;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
}
</style>
  
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>  

</head>

<body>

<h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ï¼‹æ‹æ‰‹æ•°ï¼‰</h2>

<p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
<input type="password" id="pwInput">
<button id="pwBtn">OK</button>

<div id="content">
  <h3>ğŸ“¬ ç›´è¿‘1ã‹æœˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§</h3>
  <div id="messages"></div>

  <h3>ğŸ‘ æ‹æ‰‹æ•°</h3>
  <p id="clapCount">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, query, where, Timestamp }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC74BiEEMF1D8C7Ll99kWBJE5UqTC8T8Hw",
    authDomain: "kado-onyx-clap.firebaseapp.com",
    projectId: "kado-onyx-clap",
    storageBucket: "kado-onyx-clap.firebasestorage.app",
    messagingSenderId: "1038961543704",
    appId: "1:1038961543704:web:114b43697f055c2f8f116d",
    measurementId: "G-DH6JB7CKPV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
  function checkPW() {
    const input = document.getElementById("pwInput").value;
    const correct = "onyx123";

    if (input === correct) {
      document.getElementById("content").style.display = "block";
      loadData();
    } else {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
  }

  document.getElementById("pwBtn").onclick = checkPW;

  // â–¼ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æ‹æ‰‹ï¼‰
  async function loadData() {

    // â–¼ ç›´è¿‘1ã‹æœˆ
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

    const q = query(
      collection(db, "messages"),
      where("timestamp", ">=", Timestamp.fromDate(oneMonthAgo))
    );

    const querySnapshot = await getDocs(q);

    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "";

    querySnapshot.forEach(doc => {
      const d = doc.data();
      const date = d.timestamp.toDate().toLocaleString("ja-JP");
      
     msgBox.innerHTML += `
  <div class="message-box" id="msg-${doc.id}">
    <strong>ğŸ“… ${date}</strong><br>
    ${d.text}
    <br><br>
    <button onclick="savePNG('msg-${doc.id}', '${date}')">ğŸ–¼ PNGä¿å­˜</button>
  </div>
      `;
    });

    if (querySnapshot.empty) {
      msgBox.innerHTML = "<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    }

    // â–¼ æ‹æ‰‹æ•°
    const clapSnap = await getDoc(doc(db, "claps", "main"));
    if (clapSnap.exists()) {
      document.getElementById("clapCount").textContent =
        clapSnap.data().count + " å›";
    } else {
      document.getElementById("clapCount").textContent = "0 å›";
    }
  }

</script>
<script>
// â–¼ PNGä¿å­˜ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ç¶­æŒãƒ»æ¨ªå¹…å›ºå®šãƒ»ç¸¦ã¯å¯å¤‰ï¼‰
function savePNG(elementId, dateText) {
  const element = document.getElementById(elementId);

  // â‘  å…ƒã®è¦ç´ ã‚’æ’®å½±
  html2canvas(element, { scale: 2 }).then(canvas => {

    // å…ƒç”»åƒã®æ¯”ç‡ã‚’ä¿æŒã—ã¤ã¤æ¨ªå¹…ã ã‘å›ºå®š
    const FIXED_WIDTH = 600;  // â† PNGã®æ¨ªå¹…ï¼ˆè‡ªç”±ã«å¤‰æ›´å¯ï¼‰
    const scale = FIXED_WIDTH / canvas.width;
    const newHeight = canvas.height * scale;

    // â‘¡ æ–°ã—ã„ã‚­ãƒ£ãƒ³ãƒã‚¹ï¼ˆæ¨ªå›ºå®šãƒ»ç¸¦å¯å¤‰ï¼‰
    const fixedCanvas = document.createElement("canvas");
    fixedCanvas.width = FIXED_WIDTH;
    fixedCanvas.height = newHeight;

    const ctx = fixedCanvas.getContext("2d");

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   èƒŒæ™¯ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    ctx.fillStyle = "#faf5ff";     // èƒŒæ™¯è‰²
    ctx.fillRect(0, 0, FIXED_WIDTH, newHeight);

    // ãƒ•ãƒ¬ãƒ¼ãƒ ç·š
    ctx.strokeStyle = "#9370db";
    ctx.lineWidth = 6;
    ctx.strokeRect(3, 3, FIXED_WIDTH - 6, newHeight - 6);

    // â‘¢ å…ƒã®ã‚­ãƒ£ãƒ—ãƒãƒ£ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºã—ã¦æç”»
    ctx.drawImage(
      canvas,
      0, 0, canvas.width, canvas.height,
      0, 0, FIXED_WIDTH, newHeight
    );

    // â‘£ ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ã€Œæ—¥ä»˜_message.pngã€ã«ã™ã‚‹
    const safeDate = dateText.replace(/[\/: ]/g, "-");
    const filename = safeDate + "_message.png";

    const link = document.createElement("a");
    link.download = filename;
    link.href = fixedCanvas.toDataURL("image/png");
    link.click();
  });
}
</script>


</body>
</html>
