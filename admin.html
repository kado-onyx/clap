<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†ç”»é¢</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body {
  font-family: monospace; /* â†æ¨™æº–ãƒ•ã‚©ãƒ³ãƒˆ */
  background-color: #000;
  color: #c490ff;
  padding: 20px;
}

/* --- ãƒœãƒƒã‚¯ã‚¹ --- */
.box {
  border: 2px solid #a060ff;
  padding: 15px;
  margin-bottom: 25px;
  border-radius: 6px;
}

/* --- ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ --- */
.msg-item {
  border-bottom: 1px solid #444;
  padding: 10px 0;
}

/* PNGä¿å­˜ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã¯éè¡¨ç¤ºã§OK */
#canvas {
  display: none;
}
</style>
</head>

<body>

<h1>ğŸ“Š ç®¡ç†ç”»é¢ï¼ˆæ‹æ‰‹ãƒ»è¨ªå•ãƒ»ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰</h1>


<!-- â– â– â–  æ‹æ‰‹ & è¨ªå•æ•°è¡¨ç¤º â– â– â–  -->
<div class="box">
  <h2>ğŸ“ˆ ä»Šæ—¥ã®ã‚«ã‚¦ãƒ³ãƒˆ</h2>
  <p>æœ¬æ—¥ã®è¨ªå•æ•°ï¼š<span id="visitToday">0</span></p>
  <p>æœ¬æ—¥ã®æ‹æ‰‹æ•°ï¼š<span id="clapToday">0</span></p>
</div>


<!-- â– â– â–  ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ â– â– â–  -->
<div class="box">
  <h2>ğŸ’¬ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§</h2>
  <div id="messageList"></div>
</div>


<!-- PNG ä¿å­˜ã®ãŸã‚ã®ã‚­ãƒ£ãƒ³ãƒã‚¹ -->
<canvas id="canvas"></canvas>


<!-- Firebase SDK -->
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
import { 
  getFirestore, collection, getDocs, doc, getDoc 
} from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

// --- Firebaseè¨­å®š ---
const firebaseConfig = {
  apiKey: "AIzaSyC74BiEEMF1D8C7Ll99kWBJE5UqTC8T8Hw",
  authDomain: "kado-onyx-clap.firebaseapp.com",
  projectId: "kado-onyx-clap",
  storageBucket: "kado-onyx-clap.firebasestorage.app",
  messagingSenderId: "1038961543704",
  appId: "1:1038961543704:web:114b43697f055c2f8f116d"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);


// ----------------------------
// ä»Šæ—¥ã®è¨ªå•æ•°ãƒ»æ‹æ‰‹æ•°ã‚’å–å¾—
// ----------------------------
async function loadCounts() {
  const today = new Date().toISOString().slice(0,10);
  const ref = doc(db, "daily", today);
  const snap = await getDoc(ref);
  if (snap.exists()) {
    const data = snap.data();
    document.getElementById("visitToday").textContent = data.visits ?? 0;
    document.getElementById("clapToday").textContent = data.claps ?? 0;
  }
}


// ----------------------------
// ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ã‚’è¡¨ç¤º
// ----------------------------
async function loadMessages() {
  const msgBox = document.getElementById("messageList");
  msgBox.innerHTML = "";

  const querySnapshot = await getDocs(collection(db, "messages"));
  let list = [];

  querySnapshot.forEach(doc => {
    const d = doc.data();
    list.push({
      text: d.text,
      time: d.timestamp ? d.timestamp.toDate() : new Date(0)
    });
  });

  // æ–°ã—ã„é †
  list.sort((a,b) => b.time - a.time);

  list.forEach(msg => {
    const div = document.createElement("div");
    div.className = "msg-item";

    const dateStr = msg.time.toLocaleString("ja-JP");

    div.innerHTML = `
      <div><b>${dateStr}</b></div>
      <div>${msg.text}</div>
      <button onclick="savePNG('${dateStr.replace(/[- :]/g,'_')}', \`${msg.text}\`)">PNGä¿å­˜</button>
    `;

    msgBox.appendChild(div);
  });
}


// ----------------------------
// PNGç”Ÿæˆå‡¦ç†ï¼ˆframe.png + æ–‡å­—ï¼‰
// ----------------------------
window.savePNG = async function(dateStr, message) {
  const frame = new Image();
  frame.src = "frame.png";

  await frame.decode(); // èª­ã¿è¾¼ã¿

  const canvas = document.getElementById("canvas");
  const ctx = canvas.getContext("2d");

  // åŸºæœ¬ã‚µã‚¤ã‚º
  const width = 320;
  let height = 128; // åŸºæœ¬ã‚µã‚¤ã‚º

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ–‡å­—æŠ˜ã‚Šè¿”ã—
  ctx.font = "12px monospace";
  const lines = wrapText(ctx, message, 280);
  height = 80 + lines.length * 16;  // é«˜ã•èª¿æ•´

  canvas.width = width;
  canvas.height = height;

  // é»’èƒŒæ™¯
  ctx.fillStyle = "#000";
  ctx.fillRect(0,0,width,height);

  // ãƒ•ãƒ¬ãƒ¼ãƒ æç”»ï¼ˆä¸Šã«å›ºå®šï¼‰
  ctx.drawImage(frame, 0, 0, width, 128);

  // æ—¥ä»˜
  ctx.fillStyle = "#fff";
  ctx.font = "12px monospace";
  ctx.fillText(dateStr, 21, 32);

  // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæŠ˜ã‚Šè¿”ã—ï¼‰
  let y = 60;
  for (let line of lines) {
    ctx.fillText(line, 21, y);
    y += 16;
  }

  // ä¿å­˜
  const a = document.createElement("a");
  a.href = canvas.toDataURL("image/png");
  a.download = `${dateStr}_message.png`;
  a.click();
};


// æ–‡å­—æŠ˜ã‚Šè¿”ã—ãƒ˜ãƒ«ãƒ‘ãƒ¼
function wrapText(ctx, text, maxWidth) {
  const words = text.split("");
  let lines = [];
  let current = "";

  for (let ch of words) {
    if (ctx.measureText(current + ch).width > maxWidth) {
      lines.push(current);
      current = ch;
    } else {
      current += ch;
    }
  }
  if (current) lines.push(current);

  return lines;
}


// åˆæœŸãƒ­ãƒ¼ãƒ‰
loadCounts();
loadMessages();
</script>

</body>
</html>
