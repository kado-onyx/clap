<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ç®¡ç†è€…ãƒšãƒ¼ã‚¸</title>

<style>
body {
  background: #222;
  color: #fff;
  font-family: sans-serif;
  padding: 20px;
}
input {
  padding: 8px;
  width: 200px;
  font-size: 16px;
}
button {
  padding: 8px 16px;
  margin-left: 10px;
  font-size: 14px;
}
#content {
  display: none;
  margin-top: 20px;
}
.message-box {
  background: #333;
  padding: 12px;
  margin-bottom: 10px;
  border-radius: 6px;
}
</style>
</head>

<body>

<h2>ç®¡ç†è€…ãƒšãƒ¼ã‚¸ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§ï¼‹æ‹æ‰‹æ•°ï¼‰</h2>

<p>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</p>
<input type="password" id="pwInput">
<button id="pwBtn">OK</button>

<div id="content">
  <h3>ğŸ“¬ ç›´è¿‘1ã‹æœˆã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸€è¦§</h3>
  <div id="messages"></div>

  <h3>ğŸ‘ æ‹æ‰‹æ•°</h3>
  <p id="clapCount">èª­ã¿è¾¼ã¿ä¸­â€¦</p>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc, query, where, Timestamp }
    from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC74BiEEMF1D8C7Ll99kWBJE5UqTC8T8Hw",
    authDomain: "kado-onyx-clap.firebaseapp.com",
    projectId: "kado-onyx-clap",
    storageBucket: "kado-onyx-clap.firebasestorage.app",
    messagingSenderId: "1038961543704",
    appId: "1:1038961543704:web:114b43697f055c2f8f116d",
    measurementId: "G-DH6JB7CKPV"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // â–¼ ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒã‚§ãƒƒã‚¯
  function checkPW() {
    const input = document.getElementById("pwInput").value;
    const correct = "onyx123";

    if (input === correct) {
      document.getElementById("content").style.display = "block";
      loadData();
    } else {
      alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™");
    }
  }

  document.getElementById("pwBtn").onclick = checkPW;

  // â–¼ ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ + æ‹æ‰‹ï¼‰
  async function loadData() {

    // â–¼ ç›´è¿‘1ã‹æœˆ
    const oneMonthAgo = new Date();
    oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);

    const q = query(
      collection(db, "messages"),
      where("timestamp", ">=", Timestamp.fromDate(oneMonthAgo))
    );

    const querySnapshot = await getDocs(q);

    const msgBox = document.getElementById("messages");
    msgBox.innerHTML = "";

    querySnapshot.forEach(doc => {
      const d = doc.data();
      const date = d.timestamp.toDate().toLocaleString("ja-JP");
      msgBox.innerHTML += `
        <div class="message-box">
          <strong>ğŸ“… ${date}</strong><br>
          ${d.text}
        </div>
      `;
    });

    if (querySnapshot.empty) {
      msgBox.innerHTML = "<p>ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>";
    }

    // â–¼ æ‹æ‰‹æ•°
    const clapSnap = await getDoc(doc(db, "claps", "main"));
    if (clapSnap.exists()) {
      document.getElementById("clapCount").textContent =
        clapSnap.data().count + " å›";
    } else {
      document.getElementById("clapCount").textContent = "0 å›";
    }
  }

</script>

</body>
</html>
